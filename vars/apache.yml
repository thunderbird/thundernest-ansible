apache_remove_default_vhost: true
apache_vhosts_filename: "ssl.conf"

apache_global_vhost_settings: |
      LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
      LogFormat "%h %l %u %t \"%r\" %>s %b" common
      LogFormat "%v: %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" vcombined
      CustomLog "logs/access_log" vcombined
      
      ServerLimit 32
      StartServers 8
      MaxRequestWorkers 1024
      MinSpareThreads 25
      MaxSpareThreads 75
      ThreadsPerChild 32

      AddOutputFilterByType DEFLATE text/plain
      AddOutputFilterByType DEFLATE text/html
      AddOutputFilterByType DEFLATE text/xml
      AddOutputFilterByType DEFLATE text/css
      AddOutputFilterByType DEFLATE application/xml
      AddOutputFilterByType DEFLATE application/xhtml+xml
      AddOutputFilterByType DEFLATE application/rss+xml
      AddOutputFilterByType DEFLATE application/javascript
      AddOutputFilterByType DEFLATE application/x-javascript

      LoadModule ssl_module modules/mod_ssl.so
      Listen 443
      SSLPassPhraseDialog  builtin
      SSLSessionCache         shmcb:/var/cache/mod_ssl/scache(512000)
      SSLSessionCacheTimeout  300
      Mutex default
      SSLRandomSeed startup file:/dev/urandom  256
      SSLRandomSeed connect builtin
      SSLCryptoDevice builtin
apache_vhosts_template: "vars/vhost_template.j2"
apache_certificate_key_file: "/etc/httpd/conf/privkey.pem"
apache_certificate_file: "/etc/httpd/conf/cert.pem"
apache_certificate_chain_file: "/etc/httpd/conf/chain.pem"
non_ssl_parameters: |
      ExpiresActive On
      ExpiresDefault "access plus 6 hours"
      RewriteEngine On
      RewriteCond %{HTTPS} off
      RewriteRule ^.*$ https://%{SERVER_NAME}%{REQUEST_URI} [L,R=301,NE]

apache_vhosts:
  - servername: "live.thunderbird.net"
    serveralias: "live.mozillamessaging.com live-stage.thunderbird.net"
    documentroot: "/var/www/html/live.momo/htaccess/"
    extra_parameters: |
      ExpiresActive On
      ExpiresDefault "access plus 6 hours"

  - servername: "autoconfig.thunderbird.net"
    serveralias: "autoconfig-live.mozillamessaging.com autoconfig-stage.thunderbird.net"
    documentroot: "/var/www/html/autoconfig.momo/"
    options: "+Indexes +FollowSymLinks"
    extra_parameters: |
      <Location ~ "/v1(\.0|\.1)/">
        Header set Access-Control-Allow-Origin "*"
        ForceType text/xml
      </Location>
      ExpiresActive On
      ExpiresDefault "access plus 1 hour"
      RewriteEngine On
      RewriteRule ^/autoconfig/(.*)$ /$1 [L,R=301,NE]
      ErrorLog "|/usr/sbin/rotatelogs /var/log/httpd/autoconfig/error_log_%Y-%m-%d 604800 -480"
      CustomLog "|/usr/sbin/rotatelogs /var/log/httpd/autoconfig/access_%Y-%m-%d 604800 -480" combined
      Header always set Strict-Transport-Security "max-age=31536000"

  - servername: "broker.thunderbird.net"
    serveralias: "broker-live.mozillamessaging.com broker-stage.thunderbird.net"
    documentroot: "/var/www/services/broker"
    extra_parameters: |
      RedirectMatch 404 /\.git
      WSGIDaemonProcess broker.thunderbird.net processes=2 threads=15 display-name=%{GROUP} python-home=/var/www/tbservices
      WSGIProcessGroup broker.thunderbird.net
      WSGIScriptAlias /provider /var/www/services/broker/broker.wsgi
      CustomLog /dev/null common
      ErrorLog /dev/null

  - servername: "mx.thunderbird.net"
    serveralias: "mx-live.mozillamessaging.com mx-stage.thunderbird.net"
    documentroot: "/var/www/services/mx"
    extra_parameters: |
      WSGIDaemonProcess mx.thunderbird.net processes=2 threads=15 display-name=%{GROUP} python-home=/var/www/tbservices
      WSGIProcessGroup mx.thunderbird.net
      WSGIScriptAlias /dns/mx /var/www/services/mx/wsgi.py

  - servername: "support.thunderbird.net"
    serveralias: "support.mozillamessaging.com support-stage.thunderbird.net"
    extra_parameters: |
      RewriteEngine On
      RewriteCond %{HTTP:X-Forwarded-Proto} ^http$
      RewriteRule ^.*$ https://%{SERVER_NAME}%{REQUEST_URI} [L,R=301,NE]
      RewriteCond %{REQUEST_URI} ^/kb/ask$
      RewriteRule (.*) https://support.mozilla.org/en-US/questions/new/thunderbird [L]
      RewriteCond %{REQUEST_URI} ^/([^/]+)/kb/ask$
      RewriteRule (.*) https://support.mozilla.org/%1/questions/new/thunderbird [L]
      RewriteCond %{REQUEST_URI} ^/([^/]+)/kb/category/20$
      RewriteRule (.*) https://support.mozilla.org/%1/products/thunderbird/how [L]
      RewriteCond %{REQUEST_URI} ^/kb/category/20$
      RewriteRule (.*) https://support.mozilla.org/products/thunderbird/how [L]
      RewriteCond %{REQUEST_URI} ^/kb/filelink-large-attachments$
      RewriteRule (.*) https://support.mozilla.org/kb/filelink-large-attachments [L]
      RewriteCond %{REQUEST_URI} ^/[^/]+/kb/.*
      RewriteRule (.*) https://support.mozilla.org$1 [L]
      RewriteCond %{REQUEST_URI} ^/kb/(.*)
      RewriteRule (.*) https://support.mozilla.org/kb/%1 [L]
      RewriteCond %{REQUEST_URI} ^/([^/]+)/home
      RewriteRule (.*) https://support.mozilla.org/%1/products/thunderbird [L]
      RewriteCond %{REQUEST_URI} ^/(.*)$
      RewriteRule (.*) https://support.mozilla.org/products/thunderbird [L]

  - servername: "support.live.mozillamessaging.com"
    serveralias: "support-stage.live.thunderbird.net"
    extra_parameters: |
      ExpiresActive On
      ExpiresDefault "access plus 6 hours"
      <Location />
        RewriteEngine On
        RewriteRule .* http://support.mozillamessaging.com/ [R=302]
      </Location>

  - servername: "thunderbird.net"
    serveralias: "mozillamessaging.com www.mozillamessaging.com getthunderbird.com www.getthunderbird.com"
    extra_parameters: |
      ExpiresActive On
      ExpiresDefault "access plus 6 hours"
      <Location />
        RewriteEngine On
        RewriteRule .* https://www.thunderbird.net%{REQUEST_URI} [R=302]
      </Location>
      Header always set Strict-Transport-Security "max-age=31536000"

  - servername: "www-new.thunderbird.net"
    extra_parameters: |
      ExpiresActive On
      ExpiresDefault "access plus 24 hours"
      <Location />
        RewriteEngine On
        RewriteRule .* https://www-stage.thunderbird.net%{REQUEST_URI} [R=302]
      </Location>
      Header always set Strict-Transport-Security "max-age=31536000"  

  - servername: "www.thunderbird.net"
    serveralias: "www-stage.thunderbird.net stage.thunderbird.net"
    documentroot: "/var/www/html/start/thunderbird.net"
    extra_parameters: |
      RewriteEngine On
      WSGIDaemonProcess stage.thunderbird.net processes=2 threads=15 display-name=%{GROUP} python-home=/var/www/tbservices python-path=/var/www/html/start
      WSGIProcessGroup stage.thunderbird.net

      RewriteRule ^/(.*)/thunderbird/60\.0/whatsnew/$ https://support.mozilla.org/$1/kb/new-thunderbird-60 [R=302,L]
      # https://github.com/thundernest/thunderbird-website/issues/162
      RewriteRule ^/ja-JP-mac/?(.*)$ /ja/$1 [R=302]
      # https://github.com/thundernest/thunderbird.net-l10n/issues/1
      RewriteRule ^/bn-(?:BD|IN)/?(.*)$ /bn/$1 [R=302]
      RewriteRule ^/privacy/? https://www.mozilla.org/privacy/thunderbird/ [R=302]
      RewriteRule ^/thunderbird/(latest/)?system-requirements/? /system-requirements/ [R=302]
      RewriteRule ^/thunderbird/notes/? /notes/ [R=302]
      RewriteRule ^/releases/? /thunderbird/releases/ [R=302]
      # https://github.com/thundernest/thunderbird-website/issues/160
      RewriteRule ^(.*)/channel/? #channel [R=302,NE]
      WSGIScriptAliasMatch ^/$ /var/www/html/start/wsgi.py
      WSGIScriptAliasMatch ^/about[/]?$ /var/www/html/start/wsgi.py
      WSGIScriptAliasMatch ^/download[/]?$ /var/www/html/start/wsgi.py
      WSGIScriptAliasMatch ^/features[/]?$ /var/www/html/start/wsgi.py
      WSGIScriptAliasMatch ^/organizations[/]?$ /var/www/html/start/wsgi.py
      WSGIScriptAliasMatch ^/thunderbird /var/www/html/start/wsgi.py
      ExpiresActive On
      ExpiresDefault "access plus 8 hours"
      RewriteRule ^/calendar/?(.*)$ /en-US/calendar/$1 [R=302]
      RewriteRule ^/careers/? /en-US/careers/ [R=302]
      RewriteRule ^/contact/? /en-US/contact/ [R=302]
      RewriteRule ^/email-providers/? /en-US/email-providers/ [R=302]
      RewriteRule ^/get-involved/? /en-US/get-involved/ [R=302]
      Header always set Strict-Transport-Security "max-age=31536000"

  - servername: "start.thunderbird.net"
    serveralias: "start-stage.thunderbird.net"
    documentroot: "/var/www/html/start/site"
    extra_parameters: |
      ExpiresActive On
      ExpiresDefault "access plus 8 hours"
      RewriteEngine On
      # https://github.com/thundernest/thunderbird-website/issues/162
      RewriteRule ^/ja-JP-mac/?(.*)$ /ja/$1 [R=302]
      # https://github.com/thundernest/thunderbird.net-l10n/issues/1
      RewriteRule ^/bn-(?:BD|IN)/?(.*)$ /bn/$1 [R=302]
      RewriteRule ^/$ /en-US/release/ [R=302]
      Header always set Strict-Transport-Security "max-age=31536000"

  - servername: "mail.thunderbird.net"
    extra_parameters: |
      ExpiresActive On
      ExpiresDefault "access plus 24 hours"
      <Location />
        RewriteEngine On
        RewriteRule .* https://www.fastmail.com/login/?domain=thunderbird.net [R=302]
      </Location>

  - servername: "stats.thunderbird.net"
    serveralias: "stats-stage.thunderbird.net"
    documentroot: "/var/www/html/tbstats/docs"
    extra_parameters: |
      RedirectMatch 404 /\.git
      ExpiresActive On
      ExpiresDefault "access plus 1 hour"

  - servername: "style.thunderbird.net"
    serveralias: "style-stage.thunderbird.net"
    documentroot: "/var/www/html/style_guide/_site"
    extra_parameters: |
      RedirectMatch 404 /\.git

  - servername: "aus.thunderbird.net"
    serveralias: "aus-stage.thunderbird.net"
    extra_parameters: |
      RewriteEngine On
      Header set Cache-Control "max-age=0, no-cache, no-store, must-revalidate"
      Header set Pragma "no-cache"
      Header set Expires "Thu, 11 Jan 2001 05:00:00 GMT"
      RewriteRule ^(.*)$ https://aus5.mozilla.org$1 [R=302]

  - servername: "addons.thunderbird.net"
    serveralias: "addons-stage.thunderbird.net"
    documentroot: "/var/www/html/start/site/en-US/maintenance"
    extra_parameters:

  - servername: "discuss.thunderbird.net"
    extra_parameters: |
      ExpiresActive On
      ExpiresDefault "access plus 24 hours"
      <Location />
        RewriteEngine On
        RewriteRule .* https://thunderbird.topicbox.com/ [R=302]
      </Location>
